<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="ExamGuard Monitoring Dashboard - Real-time AI-powered exam proctoring">
    <title>Monitoring Dashboard - ExamGuard</title>

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap"
        rel="stylesheet">

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/static/css/style.css">
</head>

<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="container">
            <div class="flex" style="justify-content: space-between; align-items: center;">
                <a href="/" class="navbar-brand">
                    <i class="fas fa-shield-halved"></i>
                    ExamGuard
                </a>
                <div class="flex gap-3" style="align-items: center;">
                    <span class="nav-link">
                        <i class="fas fa-user-circle"></i>
                        Admin
                    </span>
                    <button id="theme-toggle" class="btn btn-secondary" style="padding: 0.75rem;">
                        <i class="fas fa-moon"></i>
                    </button>
                    <a href="/" class="btn btn-secondary">
                        <i class="fas fa-home"></i>
                        Home
                    </a>
                </div>
            </div>
        </div>
    </nav>

    <!-- Dashboard Container -->
    <div class="container dashboard-container">
        <!-- Control Panel -->
        <div class="control-panel">
            <div class="flex" style="justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
                <div>
                    <h2 class="dashboard-title" style="margin-bottom: 0.5rem;">
                        <i class="fas fa-video"></i>
                        Live Monitoring Dashboard
                    </h2>
                    <p class="text-secondary" style="margin: 0;">
                        Real-time AI-powered exam proctoring and malpractice detection
                    </p>
                </div>
                <div class="control-buttons">
                    <button id="start-monitoring" class="btn btn-success btn-lg">
                        <i class="fas fa-play"></i>
                        Start Monitoring
                    </button>
                    <button id="stop-monitoring" class="btn btn-danger btn-lg" disabled>
                        <i class="fas fa-stop"></i>
                        Stop Monitoring
                    </button>
                    <button id="settings-btn" class="btn btn-secondary btn-lg">
                        <i class="fas fa-cog"></i>
                        Settings
                    </button>
                </div>
            </div>
        </div>

        <!-- Stats Cards -->
        <div class="grid grid-4 mb-4">
            <div class="card">
                <div class="flex" style="justify-content: space-between; align-items: center;">
                    <div>
                        <p class="text-secondary" style="margin: 0; font-size: 0.875rem;">Status</p>
                        <h3 id="status-text" style="margin: 0.5rem 0 0 0; color: var(--text-muted);">Inactive</h3>
                    </div>
                    <div
                        style="width: 60px; height: 60px; border-radius: 50%; background: var(--bg-light); display: flex; align-items: center; justify-content: center;">
                        <i class="fas fa-power-off" style="font-size: 1.5rem; color: var(--text-muted);"></i>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="flex" style="justify-content: space-between; align-items: center;">
                    <div>
                        <p class="text-secondary" style="margin: 0; font-size: 0.875rem;">Total Alerts</p>
                        <h3 id="alert-count" style="margin: 0.5rem 0 0 0; color: var(--warning-color);">0</h3>
                    </div>
                    <div
                        style="width: 60px; height: 60px; border-radius: 50%; background: linear-gradient(135deg, #fff3cd 0%, #ffe69c 100%); display: flex; align-items: center; justify-content: center;">
                        <i class="fas fa-exclamation-triangle"
                            style="font-size: 1.5rem; color: var(--warning-color);"></i>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="flex" style="justify-content: space-between; align-items: center;">
                    <div>
                        <p class="text-secondary" style="margin: 0; font-size: 0.875rem;">Session Duration</p>
                        <h3 id="session-time" style="margin: 0.5rem 0 0 0; color: var(--info-color);">00:00:00</h3>
                    </div>
                    <div
                        style="width: 60px; height: 60px; border-radius: 50%; background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%); display: flex; align-items: center; justify-content: center;">
                        <i class="fas fa-clock" style="font-size: 1.5rem; color: var(--info-color);"></i>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="flex" style="justify-content: space-between; align-items: center;">
                    <div>
                        <p class="text-secondary" style="margin: 0; font-size: 0.875rem;">AI Confidence</p>
                        <h3 id="ai-confidence" style="margin: 0.5rem 0 0 0; color: var(--success-color);">--</h3>
                    </div>
                    <div
                        style="width: 60px; height: 60px; border-radius: 50%; background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%); display: flex; align-items: center; justify-content: center;">
                        <i class="fas fa-brain" style="font-size: 1.5rem; color: var(--success-color);"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content Grid -->
        <div class="grid" style="grid-template-columns: 2fr 1fr; gap: 1.5rem;">
            <!-- Video Feed -->
            <div>
                <div class="card" style="padding: 0; overflow: hidden;">
                    <div class="card-header"
                        style="padding: 1rem 1.5rem; background: var(--bg-card); border-bottom: 1px solid var(--border-color);">
                        <i class="fas fa-video"></i>
                        Live Video Feed
                    </div>
                    <div class="video-container" style="border-radius: 0;">
                        <img id="video-feed" src="" alt="Video feed will appear here">
                        <div class="video-overlay" id="recording-badge" style="display: none;">
                            <div class="recording-indicator"></div>
                            <span>RECORDING</span>
                        </div>
                    </div>
                </div>

                <!-- Detection Settings -->
                <div class="card mt-3">
                    <div class="card-header">
                        <i class="fas fa-sliders-h"></i>
                        Active Detection Modules
                    </div>
                    <div class="grid grid-2" style="gap: 1rem;">
                        <div class="flex"
                            style="align-items: center; justify-content: space-between; padding: 0.75rem; background: var(--bg-light); border-radius: var(--radius-sm);">
                            <div class="flex gap-2" style="align-items: center;">
                                <i class="fas fa-eye" style="color: var(--primary-color);"></i>
                                <span style="font-weight: 500;">Gaze Detection</span>
                            </div>
                            <div
                                style="width: 12px; height: 12px; background: var(--success-color); border-radius: 50%;">
                            </div>
                        </div>
                        <div class="flex"
                            style="align-items: center; justify-content: space-between; padding: 0.75rem; background: var(--bg-light); border-radius: var(--radius-sm);">
                            <div class="flex gap-2" style="align-items: center;">
                                <i class="fas fa-mobile-alt" style="color: var(--primary-color);"></i>
                                <span style="font-weight: 500;">Object Detection</span>
                            </div>
                            <div
                                style="width: 12px; height: 12px; background: var(--success-color); border-radius: 50%;">
                            </div>
                        </div>
                        <div class="flex"
                            style="align-items: center; justify-content: space-between; padding: 0.75rem; background: var(--bg-light); border-radius: var(--radius-sm);">
                            <div class="flex gap-2" style="align-items: center;">
                                <i class="fas fa-user-friends" style="color: var(--primary-color);"></i>
                                <span style="font-weight: 500;">Multiple Persons</span>
                            </div>
                            <div
                                style="width: 12px; height: 12px; background: var(--success-color); border-radius: 50%;">
                            </div>
                        </div>
                        <div class="flex"
                            style="align-items: center; justify-content: space-between; padding: 0.75rem; background: var(--bg-light); border-radius: var(--radius-sm);">
                            <div class="flex gap-2" style="align-items: center;">
                                <i class="fas fa-hand-paper" style="color: var(--primary-color);"></i>
                                <span style="font-weight: 500;">Gesture Recognition</span>
                            </div>
                            <div
                                style="width: 12px; height: 12px; background: var(--success-color); border-radius: 50%;">
                            </div>
                        </div>
                        <div class="flex"
                            style="align-items: center; justify-content: space-between; padding: 0.75rem; background: var(--bg-light); border-radius: var(--radius-sm);">
                            <div class="flex gap-2" style="align-items: center;">
                                <i class="fas fa-brain" style="color: var(--primary-color);"></i>
                                <span style="font-weight: 500;">Pose Analysis</span>
                            </div>
                            <div
                                style="width: 12px; height: 12px; background: var(--success-color); border-radius: 50%;">
                            </div>
                        </div>
                        <div class="flex"
                            style="align-items: center; justify-content: space-between; padding: 0.75rem; background: var(--bg-light); border-radius: var(--radius-sm);">
                            <div class="flex gap-2" style="align-items: center;">
                                <i class="fas fa-robot" style="color: var(--primary-color);"></i>
                                <span style="font-weight: 500;">AI Processing</span>
                            </div>
                            <div
                                style="width: 12px; height: 12px; background: var(--success-color); border-radius: 50%;">
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Alert Log -->
            <div>
                <div class="card" style="height: 100%;">
                    <div class="card-header">
                        <i class="fas fa-exclamation-triangle"></i>
                        Malpractice Alert Log
                    </div>
                    <div class="alert-log-container" id="alert-log">
                        <div class="empty-state">
                            <i class="fas fa-shield-alt"></i>
                            <p>Start monitoring to view alerts</p>
                            <p style="font-size: 0.875rem;">All suspicious activities will appear here</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settings-modal"
        style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.5); z-index: 2000; align-items: center; justify-content: center;">
        <div class="card" style="max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto;">
            <div class="flex" style="justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                <h3 style="margin: 0;">
                    <i class="fas fa-cog"></i>
                    Detection Settings
                </h3>
                <button id="close-settings" class="btn btn-secondary" style="padding: 0.5rem 1rem;">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <div style="margin-bottom: 1.5rem;">
                <h4 style="margin-bottom: 1rem;">Object Detection</h4>
                <label style="display: block; margin-bottom: 0.5rem;">
                    <input type="checkbox" checked> Enable Object Detection
                </label>
                <label style="display: block; margin-bottom: 0.5rem;">
                    Confidence Threshold: <span id="obj-conf-value">0.55</span>
                </label>
                <input type="range" min="0.3" max="0.9" step="0.05" value="0.55" id="obj-conf-slider"
                    style="width: 100%;">
            </div>

            <div style="margin-bottom: 1.5rem;">
                <h4 style="margin-bottom: 1rem;">Gaze Detection</h4>
                <label style="display: block; margin-bottom: 0.5rem;">
                    <input type="checkbox" checked> Enable Gaze Detection
                </label>
                <label style="display: block; margin-bottom: 0.5rem;">
                    Alert Threshold (seconds): <span id="gaze-time-value">3.0</span>
                </label>
                <input type="range" min="1" max="10" step="0.5" value="3" id="gaze-time-slider" style="width: 100%;">
            </div>

            <div style="margin-bottom: 1.5rem;">
                <h4 style="margin-bottom: 1rem;">Pose Detection</h4>
                <label style="display: block; margin-bottom: 0.5rem;">
                    <input type="checkbox" checked> Enable Pose Detection
                </label>
                <label style="display: block; margin-bottom: 0.5rem;">
                    Hand Near Head Threshold (seconds): <span id="pose-time-value">2.0</span>
                </label>
                <input type="range" min="1" max="10" step="0.5" value="2" id="pose-time-slider" style="width: 100%;">
            </div>

            <button class="btn btn-primary" style="width: 100%;" id="save-settings">
                <i class="fas fa-save"></i>
                Save Settings
            </button>
        </div>
    </div>

    <!-- JavaScript -->
    <script>
        // Theme Toggle
        const themeToggle = document.getElementById('theme-toggle');
        const body = document.body;

        const currentTheme = localStorage.getItem('theme') || 'light';
        if (currentTheme === 'dark') {
            body.classList.add('dark-mode');
            themeToggle.innerHTML = '<i class="fas fa-sun"></i>';
        }

        themeToggle.addEventListener('click', () => {
            body.classList.toggle('dark-mode');
            const isDark = body.classList.contains('dark-mode');
            themeToggle.innerHTML = isDark ? '<i class="fas fa-sun"></i>' : '<i class="fas fa-moon"></i>';
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
        });

        // Monitoring State
        let isMonitoring = false;
        let updateInterval = null;
        let sessionStartTime = null;
        let timerInterval = null;

        const startBtn = document.getElementById('start-monitoring');
        const stopBtn = document.getElementById('stop-monitoring');
        const videoFeed = document.getElementById('video-feed');
        const alertLog = document.getElementById('alert-log');
        const statusText = document.getElementById('status-text');
        const alertCount = document.getElementById('alert-count');
        const sessionTime = document.getElementById('session-time');
        const recordingBadge = document.getElementById('recording-badge');

        // Settings Modal
        const settingsBtn = document.getElementById('settings-btn');
        const settingsModal = document.getElementById('settings-modal');
        const closeSettings = document.getElementById('close-settings');

        settingsBtn.addEventListener('click', () => {
            settingsModal.style.display = 'flex';
        });

        closeSettings.addEventListener('click', () => {
            settingsModal.style.display = 'none';
        });

        // Settings sliders
        document.getElementById('obj-conf-slider').addEventListener('input', (e) => {
            document.getElementById('obj-conf-value').textContent = e.target.value;
        });

        document.getElementById('gaze-time-slider').addEventListener('input', (e) => {
            document.getElementById('gaze-time-value').textContent = e.target.value;
        });

        document.getElementById('pose-time-slider').addEventListener('input', (e) => {
            document.getElementById('pose-time-value').textContent = e.target.value;
        });

        document.getElementById('save-settings').addEventListener('click', () => {
            settingsModal.style.display = 'none';
            // Here you would send settings to backend
            alert('Settings saved successfully!');
        });

        // Start Monitoring
        startBtn.addEventListener('click', async () => {
            try {
                const response = await fetch('/start_monitoring');
                const data = await response.json();

                if (data.status === 'started') {
                    isMonitoring = true;
                    startBtn.disabled = true;
                    stopBtn.disabled = false;

                    videoFeed.src = '/video_feed?' + new Date().getTime();
                    recordingBadge.style.display = 'flex';

                    statusText.textContent = 'Active';
                    statusText.style.color = 'var(--success-color)';

                    sessionStartTime = new Date();
                    startTimer();

                    updateInterval = setInterval(fetchAlerts, 2000);
                }
            } catch (error) {
                console.error('Error starting monitoring:', error);
                alert('Failed to start monitoring. Please check your camera.');
            }
        });

        // Stop Monitoring
        stopBtn.addEventListener('click', async () => {
            try {
                const response = await fetch('/stop_monitoring');
                const data = await response.json();

                if (data.status === 'stopped') {
                    isMonitoring = false;
                    startBtn.disabled = false;
                    stopBtn.disabled = true;

                    videoFeed.src = '';
                    recordingBadge.style.display = 'none';

                    statusText.textContent = 'Inactive';
                    statusText.style.color = 'var(--text-muted)';

                    clearInterval(updateInterval);
                    clearInterval(timerInterval);

                    alertLog.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-shield-alt"></i>
                            <p>Start monitoring to view alerts</p>
                            <p style="font-size: 0.875rem;">All suspicious activities will appear here</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error stopping monitoring:', error);
            }
        });

        // Fetch Alerts
        async function fetchAlerts() {
            if (!isMonitoring) return;

            try {
                const response = await fetch('/get_alerts');
                const data = await response.json();
                renderAlerts(data.alerts);
            } catch (error) {
                console.error('Error fetching alerts:', error);
            }
        }

        // Render Alerts
        function renderAlerts(alerts) {
            if (!isMonitoring) return;

            alertCount.textContent = alerts.length;

            if (alerts.length === 0) {
                alertLog.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-check-circle" style="color: var(--success-color);"></i>
                        <p style="color: var(--success-color);">No suspicious activity detected</p>
                        <p style="font-size: 0.875rem;">All systems normal</p>
                    </div>
                `;
                return;
            }

            const alertsHtml = alerts.map(alert => {
                const severity = alert.description.includes('Prohibited') ? 'danger' : 'warning';
                return `
                    <div class="alert-item ${severity}">
                        <div class="alert-header">
                            <div class="alert-title">
                                <i class="fas fa-exclamation-circle"></i>
                                ${alert.description.split(':')[0]}
                            </div>
                            <div class="alert-time">${alert.time}</div>
                        </div>
                        <div class="alert-description">
                            ${alert.description}
                        </div>
                    </div>
                `;
            }).join('');

            alertLog.innerHTML = alertsHtml;
            alertLog.scrollTop = 0;
        }

        // Session Timer
        function startTimer() {
            timerInterval = setInterval(() => {
                if (!sessionStartTime) return;

                const now = new Date();
                const diff = now - sessionStartTime;

                const hours = Math.floor(diff / 3600000);
                const minutes = Math.floor((diff % 3600000) / 60000);
                const seconds = Math.floor((diff % 60000) / 1000);

                sessionTime.textContent =
                    `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
            }, 1000);
        }

        // Simulate AI Confidence (in production, this would come from backend)
        setInterval(() => {
            if (isMonitoring) {
                const confidence = (95 + Math.random() * 5).toFixed(1);
                document.getElementById('ai-confidence').textContent = confidence + '%';
            }
        }, 3000);
    </script>
</body>

</html>